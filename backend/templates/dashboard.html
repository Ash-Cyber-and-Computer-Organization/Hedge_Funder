<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hedge Funder Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 30px; }
        .card { background: white; border-radius: 8px; padding: 20px; margin: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .signal { padding: 10px; margin: 5px 0; border-radius: 4px; }
        .buy { background-color: #d4edda; border: 1px solid #c3e6cb; }
        .sell { background-color: #f8d7da; border: 1px solid #f5c6cb; }
        .hold { background-color: #fff3cd; border: 1px solid #ffeaa7; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 8px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background-color: #f8f9fa; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Hedge Funder Dashboard</h1>
            <button onclick="refreshData()">Refresh Data</button>
        </div>

        <div class="grid">
            <div class="card">
                <h3>Portfolio Summary</h3>
                <div id="portfolio-summary">Loading...</div>
            </div>

            <div class="card">
                <h3>Database Stats</h3>
                <div id="stats">Loading...</div>
            </div>
        </div>

        <div class="card">
            <h3>Latest Trade Signals</h3>
            <div id="signals">Loading...</div>
        </div>

        <div class="card">
            <h3>Portfolio Positions</h3>
            <div id="portfolio">Loading...</div>
        </div>

        <div class="card">
            <h3>Recent Transactions</h3>
            <div id="transactions">Loading...</div>
        </div>
    </div>

    <script>
        async function fetchData(endpoint) {
            try {
                const response = await fetch(`http://localhost:5000${endpoint}`);
                return await response.json();
            } catch (error) {
                console.error('Error fetching data:', error);
                return null;
            }
        }

        function formatCurrency(value) {
            return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(value);
        }

        function formatDate(dateString) {
            return new Date(dateString).toLocaleString();
        }

        function renderSignals(signals) {
            if (!signals || signals.length === 0) {
                return '<p>No signals available</p>';
            }

            return signals.map(signal => `
                <div class="signal ${signal.action}">
                    <strong>${signal.ticker}</strong> - ${signal.action.toUpperCase()}
                    <br>Price: ${formatCurrency(signal.current_price)}
                    <br>SMA: ${signal.sma_20 ? signal.sma_20.toFixed(2) : 'N/A'}
                    <br>RSI: ${signal.rsi ? signal.rsi.toFixed(2) : 'N/A'}
                    <br><small>${signal.reason}</small>
                    <br><small>${formatDate(signal.timestamp)}</small>
                </div>
            `).join('');
        }

        function renderPortfolio(portfolio) {
            if (!portfolio || portfolio.length === 0) {
                return '<p>No positions</p>';
            }

            const table = `
                <table>
                    <thead>
                        <tr>
                            <th>Ticker</th>
                            <th>Quantity</th>
                            <th>Avg Price</th>
                            <th>Current Value</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${portfolio.map(pos => `
                            <tr>
                                <td>${pos.ticker}</td>
                                <td>${pos.quantity}</td>
                                <td>${formatCurrency(pos.avg_price)}</td>
                                <td>${formatCurrency(pos.current_value)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            return table;
        }

        function renderTransactions(transactions) {
            if (!transactions || transactions.length === 0) {
                return '<p>No transactions</p>';
            }

            const table = `
                <table>
                    <thead>
                        <tr>
                            <th>Ticker</th>
                            <th>Action</th>
                            <th>Quantity</th>
                            <th>Price</th>
                            <th>Total Value</th>
                            <th>Date</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${transactions.map(tx => `
                            <tr>
                                <td>${tx.ticker}</td>
                                <td>${tx.action}</td>
                                <td>${tx.quantity}</td>
                                <td>${formatCurrency(tx.price)}</td>
                                <td>${formatCurrency(tx.total_value)}</td>
                                <td>${formatDate(tx.timestamp)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            return table;
        }

        function renderStats(stats) {
            if (!stats) return '<p>No stats available</p>';

            return `
                <p>Market Data: ${stats.market_data_count || 0}</p>
                <p>Intraday Data: ${stats.intraday_data_count || 0}</p>
                <p>Real-time Prices: ${stats.real_time_prices_count || 0}</p>
                <p>Trade Signals: ${stats.trade_signals_count || 0}</p>
                <p>Portfolio Positions: ${stats.portfolio_count || 0}</p>
                <p>Transactions: ${stats.transactions_count || 0}</p>
                <p><strong>Total Records: ${stats.total_records || 0}</strong></p>
            `;
        }

        async function loadDashboard() {
            const data = await fetchData('/api/dashboard');

            if (data) {
                document.getElementById('portfolio-summary').innerHTML =
                    `<p>Total Value: ${formatCurrency(data.total_portfolio_value || 0)}</p>`;

                document.getElementById('stats').innerHTML = renderStats(data.database_stats);
                document.getElementById('signals').innerHTML = renderSignals(data.latest_signals);
                document.getElementById('portfolio').innerHTML = renderPortfolio(data.portfolio);
                document.getElementById('transactions').innerHTML = renderTransactions(data.recent_transactions);
            }
        }

        function refreshData() {
            loadDashboard();
        }

        // Load data on page load
        loadDashboard();

        // Refresh every 30 seconds
        setInterval(refreshData, 30000);
    </script>
</body>
</html>
